name: Tests - Linux

on:
  workflow_dispatch:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    paths:
      - "src/**"
      - "tests/**"
      - "CMakeLists.txt"
      - "CMakePresets.json"
      - "vcpkg.json"
      - ".github/workflows/tests-linux.yml"
  push:
    branches:
      - main
    paths:
      - "src/**"
      - "tests/**"
      - "CMakeLists.txt"
      - "CMakePresets.json"
      - "vcpkg.json"
      - ".github/workflows/tests-linux.yml"

permissions:
  contents: read
  pull-requests: read

env:
  LUKKA_RUN_VCPKG_SHA: "${{ vars.LUKKA_RUN_VCPKG_SHA != '' && vars.LUKKA_RUN_VCPKG_SHA || 'b3dd708d38df5c856fe1c18dc0d59ab771f93921' }}"
  CMAKE_BUILD_PARALLEL_LEVEL: 2
  MAKEFLAGS: "-j 2"

jobs:
  tests:
    name: ubuntu-24.04-linux-tests
    runs-on: ubuntu-24.04
    env:
      ACTIONS_RUNTIME_TOKEN: ${{ secrets.ACTIONS_RUNTIME_TOKEN }}
      ACTIONS_CACHE_URL: ${{ secrets.ACTIONS_CACHE_URL }}

    concurrency:
      group: otclient-${{ github.workflow }}-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.event_name == 'push' && github.repository || (github.event.pull_request.head.repo.fork && github.repository || github.event.pull_request.head.repo.full_name) }}
          ref: ${{ github.event_name == 'push' && github.ref || (github.event.pull_request.head.repo.fork && github.event.pull_request.base.ref || github.event.pull_request.head.ref) }}
          fetch-depth: 0

      - name: Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ccache gcc-14 g++-14 libglew-dev libx11-dev linux-headers-$(uname -r)

      - name: Switch to GCC 14
        run: |
          sudo update-alternatives --install /usr/bin/gcc gcc /usr/bin/gcc-14 100
          sudo update-alternatives --install /usr/bin/g++ g++ /usr/bin/g++-14 100
          sudo update-alternatives --set gcc /usr/bin/gcc-14
          sudo update-alternatives --set g++ /usr/bin/g++-14

      - name: Get vcpkg commit ID
        id: vcpkg-step
        run: |
          vcpkgCommitId=$(grep '.builtin-baseline' vcpkg.json | awk -F: '{print $2}' | tr -d '," ')
          echo "vcpkgGitCommitId=$vcpkgCommitId" >> $GITHUB_OUTPUT

      - name: Compute vcpkg.json hash
        id: hash
        shell: pwsh
        run: |
          $json = Get-Content "vcpkg.json" -Raw -Encoding UTF8
          $bytes = [System.Text.Encoding]::UTF8.GetBytes($json)
          $sha256 = [System.Security.Cryptography.SHA256]::Create()
          $hashBytes = $sha256.ComputeHash($bytes)
          $hash = [BitConverter]::ToString($hashBytes) -replace '-', ''
          "hash=$hash" | Out-File -FilePath $env:GITHUB_OUTPUT -Append -Encoding utf8

      - name: Cache vcpkg binary artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/vcpkg/archives
            ${{ github.workspace }}/vcpkg/downloads
            ${{ github.workspace }}/vcpkg/installed
            ${{ github.workspace }}/vcpkg/buildtrees
          key: vcpkg-ubuntu-tests-${{ steps.hash.outputs.hash }}
          restore-keys: |
            vcpkg-ubuntu-tests-

      - name: Setup vcpkg
        uses: lukka/run-vcpkg@a400452f634fe49e9f18d388aeb1809dcc642136
        with:
          vcpkgGitCommitId: ${{ steps.vcpkg-step.outputs.vcpkgGitCommitId }}

      - name: Validate vcpkg baseline SHA
        run: |
          SHAS="${{ steps.vcpkg-step.outputs.vcpkgGitCommitId }}"
          if [ -z "${SHAS}" ]; then
            echo "::error title=Missing vcpkg baseline::Provide a full 40-char vcpkgGitCommitId."
            exit 1
          fi
          if ! echo "${SHAS}" | grep -Eq '^[0-9a-f]{40}$'; then
            echo "::error title=Invalid vcpkg baseline::vcpkgGitCommitId must be a full 40-char commit SHA."
            exit 1
          fi

      - name: Install CMake and Ninja
        uses: lukka/get-cmake@v3.31.6

      - name: Cache CMake build directory
        uses: actions/cache@v4
        with:
          path: ${{ github.workspace }}/build-linux-tests
          key: cmake-dir-linux-tests
          restore-keys: |
            cmake-dir-linux-tests

      - name: Configure
        run: |
          cmake -G Ninja -S . -B build-linux-tests \
            -DCMAKE_BUILD_TYPE=RelWithDebInfo \
            -DCMAKE_TOOLCHAIN_FILE=$VCPKG_ROOT/scripts/buildsystems/vcpkg.cmake \
            -DVCPKG_TARGET_TRIPLET=x64-linux \
            -DOTCLIENT_BUILD_TESTS=ON \
            -DTOGGLE_BIN_FOLDER=ON \
            -DOPTIONS_ENABLE_IPO=OFF \
            -DCMAKE_C_COMPILER=gcc \
            -DCMAKE_CXX_COMPILER=g++

      - name: Build
        run: cmake --build build-linux-tests

      - name: Run Tests
        run: ctest --test-dir build-linux-tests --output-on-failure --parallel 2
